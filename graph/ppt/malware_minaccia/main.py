import matplotlib.pyplot as plt
import numpy as np

# Impostazioni font globali
plt.rcParams['font.family'] = 'sans-serif'

def genera_torta_italia(ax=None, save=True):
    """Genera il grafico a torta per la distribuzione degli attacchi in Italia."""
    if ax is None:
        # Aumento ulteriormente la figura per gestire i font molto grandi e la rotazione
        fig, ax = plt.subplots(figsize=(14, 10))
    else:
        save = False 

    labels = ['Malware', 'DDoS', 'Vulnerabilities', 'Phishing', 'Altro\n+ Undisclosed']
    sizes = [38, 21, 19, 11, 11]
    colors = ['#ff4d4d', '#d9d9d9', '#d9d9d9', '#d9d9d9', '#d9d9d9']
    explode = (0.1, 0, 0, 0, 0)

    # Genera il grafico
    # Nota: fontsize=40 è molto grande, potrebbe causare sovrapposizioni
    wedges, texts, autotexts = ax.pie(sizes, explode=explode, labels=labels, autopct='%1.1f%%',
                                      shadow=True, startangle=140, colors=colors,
                                      textprops=dict(color="black", fontsize=40)) 

    # Imposta lo stile delle percentuali interne
    plt.setp(autotexts, size=25, weight="bold")
    
    # --- NUOVO CODICE: Iterazione per ruotare l'etichetta specifica ---
    for text in texts:
        if 'Vulnerabilities' in text.get_text():
            # Ruota il testo di 90 gradi (verticale)
            text.set_rotation(90)
            # Opzionale: regola l'allineamento verticale e orizzontale 
            # per cercare di posizionarlo meglio dopo la rotazione.
            # Dato il font enorme, potrebbe comunque sovrapporsi un po'.
            text.set_verticalalignment('center') 
            text.set_horizontalalignment('left') 
    # ------------------------------------------------------------------

    # Titolo ancora più evidente
    ax.set_title("Distribuzione Tecniche di Attacco in Italia (2024)\n", fontsize=24, fontweight='bold')
    ax.axis('equal')
    
    if save:
        filename = 'grafico_torta_italia.png'
        # Aumentiamo il padding per evitare che le etichette giganti vengano tagliate
        plt.tight_layout(pad=3.0) 
        plt.savefig(filename, transparent=True)
        print(f"Grafico salvato come: {filename}")
        plt.close()

# ... (le altre funzioni: genera_istogramma_confronto, genera_istogramma_istat rimangono uguali) ...

def genera_istogramma_confronto(ax=None, save=True):
    """Genera l'istogramma di confronto Italia vs Mondo."""
    if ax is None:
        fig, ax = plt.subplots(figsize=(10, 7))
    else:
        save = False

    categories = ['Mondo', 'Italia']
    malware_percentages = [32, 38]
    colors = ['#bfbfbf', '#ff4d4d']

    bars = ax.bar(categories, malware_percentages, color=colors, width=0.5)

    for bar in bars:
        height = bar.get_height()
        # Numeri sopra le barre grandi (16)
        ax.annotate(f'{height}%',
                    xy=(bar.get_x() + bar.get_width() / 2, height),
                    xytext=(0, 3),
                    textcoords="offset points",
                    ha='center', va='bottom', fontsize=16, fontweight='bold')

    ax.set_ylabel('Incidenza % sul totale incidenti', fontsize=14)
    ax.set_title('Incidenza Attacchi Malware: Italia vs Mondo', fontsize=18, fontweight='bold')
    
    # Ingranditi i testi degli assi (Mondo/Italia e numeri asse Y)
    ax.tick_params(axis='both', which='major', labelsize=14)

    ax.set_ylim(0, 50)
    ax.yaxis.grid(True, linestyle='--', alpha=0.7)
    ax.set_axisbelow(True)
    
    if save:
        filename = 'istogramma_italia_mondo.png'
        plt.tight_layout()
        plt.savefig(filename, transparent=True)
        print(f"Grafico salvato come: {filename}")
        plt.close()

def genera_istogramma_istat(ax=None, save=True):
    """Genera l'istogramma sui dati ISTAT."""
    if ax is None:
        fig, ax = plt.subplots(figsize=(10, 7))
    else:
        save = False

    categories = ['Famiglie con accesso\na Internet', 'Individui (6+) che\nusano Internet']
    percentages = [86.2, 81.9]
    colors = ['#ff4d4d', '#bfbfbf']

    bars = ax.bar(categories, percentages, color=colors, width=0.5)

    for bar in bars:
        height = bar.get_height()
        ax.annotate(f'{height}%',
                    xy=(bar.get_x() + bar.get_width() / 2, height),
                    xytext=(0, 3),
                    textcoords="offset points",
                    ha='center', va='bottom', fontsize=16, fontweight='bold')

    ax.set_ylabel('Percentuale (%)', fontsize=14)
    ax.set_title('Diffusione di Internet in Italia (2024)', fontsize=18, fontweight='bold')
    ax.tick_params(axis='both', which='major', labelsize=14)

    ax.set_ylim(0, 100)
    ax.yaxis.grid(True, linestyle='--', alpha=0.7)
    ax.set_axisbelow(True)

    if save:
        filename = 'istogramma_istat_internet.png'
        plt.tight_layout()
        plt.savefig(filename, transparent=True)
        print(f"Grafico salvato come: {filename}")
        plt.close()

def genera_dashboard_combinata():
    """Crea un'unica immagine con i grafici Clusit."""
    # Aumentata ulteriormente la larghezza e l'altezza per gestire i font enormi e la rotazione
    fig = plt.figure(figsize=(22, 11)) 
    
    gs = fig.add_gridspec(1, 2)
    
    ax1 = fig.add_subplot(gs[0, 0])
    genera_torta_italia(ax=ax1, save=False)
    
    ax2 = fig.add_subplot(gs[0, 1])
    genera_istogramma_confronto(ax=ax2, save=False)
    
    # Aumentato il padding del tight_layout
    plt.tight_layout(pad=3.0, rect=[0, 0.03, 1, 0.95])
    filename = 'combined_dashboard.png'
    plt.savefig(filename, transparent=True)
    print(f"Grafico combinato salvato come: {filename}")
    plt.close()

if __name__ == "__main__":
    print("Generazione grafici con font GIGANTI e rotazione in corso...")
    genera_torta_italia()
    # genera_istogramma_confronto() # Commentati per velocizzare il test sulla torta
    # genera_istogramma_istat()
    # genera_dashboard_combinata()
    print("Finito! Controlla i file PNG.")