import matplotlib.pyplot as plt
import numpy as np

# Impostazioni font globali
plt.rcParams['font.family'] = 'sans-serif'

# --- 1. GRAFICO A TORTA PRINCIPALE (Sinistra) ---
def genera_torta_italia(ax=None, save=True):
    if ax is None:
        fig, ax = plt.subplots(figsize=(12, 8))
    else:
        save = False 

    labels = ['Malware', 'DDoS', 'Vulnerabilities', 'Phishing', 'Altro\n+ Undisclosed']
    sizes = [38, 21, 19, 11, 11]
    colors = ['#ff4d4d', '#d9d9d9', '#d9d9d9', '#d9d9d9', '#d9d9d9']
    explode = (0.1, 0, 0, 0, 0)

    wedges, texts, autotexts = ax.pie(sizes, explode=explode, labels=labels, autopct='%1.1f%%',
                                      shadow=True, startangle=140, colors=colors,
                                      textprops=dict(color="black", fontsize=40)) 

    plt.setp(autotexts, size=25, weight="bold")
    
    # Rotazione etichetta Vulnerabilities
    for text in texts:
        if 'Vulnerabilities' in text.get_text():
            text.set_rotation(90)
            text.set_verticalalignment('center') 
            text.set_horizontalalignment('left') 

    ax.set_title("Distribuzione Tecniche di Attacco in Italia (2024)\n", fontsize=24, fontweight='bold')
    ax.axis('equal')
    
    if save:
        plt.tight_layout(pad=3.0)
        plt.savefig('grafico_torta_italia.png', transparent=True)
        plt.close()

# --- 2. NUOVA FUNZIONE: CIAMBELLE VERTICALI (Destra) ---
def genera_ciambelle_verticali(ax=None, save=True):
    """Genera due 'Donut Charts' impilate VERTICALMENTE."""
    if ax is None:
        # Figura alta e stretta per la modalità standalone
        fig, ax = plt.subplots(figsize=(6, 12))
    else:
        save = False

    # Dati
    mondo_val = 32
    italia_val = 38
    
    colors_mondo = ['#bfbfbf', '#eeeeee'] 
    colors_italia = ['#ff4d4d', '#eeeeee'] 

    # Coordinate dei centri (X, Y) per impilare verticalmente
    # X è sempre 0 (centrato), Y cambia
    center_italia = (0, 2.5)  # In alto
    center_mondo = (0, -2.5)  # In basso
    
    radius = 1.8   # Raggio aumentato per sfruttare l'altezza
    width = 0.5    # Spessore ciambella

    # --- CIAMBELLA SUPERIORE: ITALIA ---
    ax.pie([italia_val, 100-italia_val], radius=radius, center=center_italia, 
           colors=colors_italia, startangle=90, counterclock=False,
           wedgeprops=dict(width=width, edgecolor='white'))

    # Testo Percentuale ITALIA (Enorme)
    ax.text(center_italia[0], center_italia[1], f"{italia_val}%", 
            ha='center', va='center', fontsize=45, fontweight='bold', color='#ff4d4d')
    
    # Etichetta ITALIA (Sopra la ciambella)
    ax.text(center_italia[0], center_italia[1] + radius + 0.2, "ITALIA", 
            ha='center', va='bottom', fontsize=24, fontweight='bold', color='#ff4d4d')

    # --- CIAMBELLA INFERIORE: MONDO ---
    ax.pie([mondo_val, 100-mondo_val], radius=radius, center=center_mondo, 
           colors=colors_mondo, startangle=90, counterclock=False,
           wedgeprops=dict(width=width, edgecolor='white'))
    
    # Testo Percentuale MONDO
    ax.text(center_mondo[0], center_mondo[1], f"{mondo_val}%", 
            ha='center', va='center', fontsize=45, fontweight='bold', color='#555555')
    
    # Etichetta MONDO (Sopra la ciambella)
    ax.text(center_mondo[0], center_mondo[1] + radius + 0.2, "MONDO", 
            ha='center', va='bottom', fontsize=24, fontweight='bold', color='#555555')

    # --- Titolo Generale del pannello laterale ---
    # Lo mettiamo molto in alto
    ax.text(0, 5.5, "Confronto\nIncidenza Malware", ha='center', va='center', fontsize=22, fontweight='bold')

    # Impostiamo i limiti degli assi per contenere tutto verticalmente
    ax.set_xlim(-2.5, 2.5) # Stretto orizzontalmente
    ax.set_ylim(-5, 6)     # Alto verticalmente
    ax.axis('equal')
    ax.axis('off')

    if save:
        filename = 'ciambelle_verticali.png'
        plt.tight_layout()
        plt.savefig(filename, transparent=True)
        print(f"Grafico salvato come: {filename}")
        plt.close()

# --- 3. DASHBOARD COMBINATA ---
def genera_dashboard_combinata():
    """Crea dashboard con Torta Grande + Ciambelle Verticali a destra."""
    
    # Figura rettangolare (20 larghezza, 12 altezza)
    fig = plt.figure(figsize=(20, 12)) 
    
    # Griglia: Assegno molto spazio alla torta (sinistra) e una colonna stretta per le ciambelle (destra)
    # width_ratios=[2, 1] significa che la torta è larga il doppio della colonna ciambelle
    gs = fig.add_gridspec(1, 2, width_ratios=[2.5, 1])
    
    ax1 = fig.add_subplot(gs[0, 0])
    genera_torta_italia(ax=ax1, save=False)
    
    ax2 = fig.add_subplot(gs[0, 1])
    genera_ciambelle_verticali(ax=ax2, save=False)
    
    plt.tight_layout(pad=3.0, rect=[0, 0.03, 1, 0.95])
    filename = 'combined_dashboard_vertical.png'
    plt.savefig(filename, transparent=True)
    print(f"Grafico combinato salvato come: {filename}")
    plt.close()

if __name__ == "__main__":
    print("Generazione dashboard con Ciambelle Verticali...")
    genera_ciambelle_verticali() 
    genera_dashboard_combinata() 
    print("Finito!")